You are Replit Agent.

This is my BizKit AI Next.js app (pages router). It already has:
- Registration / login using JWT and cookies.
- 1 free generation for anonymous users enforced in /api/generate.
- An in-memory user store for early testing.

I am now ready for a real subscription/credits system and a real database.

Goal:
Migrate to PostgreSQL-backed users with a **credits** field, and wire /api/generate to decrement credits for logged-in users. Keep the 1-free-use logic for anonymous visitors. Do NOT remove OpenAI integration.

Tech constraints:
- Use **PostgreSQL** via the `pg` library (no Prisma needed).
- Use a single connection pool module for DB access.
- Assume I will set `DATABASE_URL` in env (Replit + Vercel).

Please do the following:

1. ADD A DB CLIENT
   - Create a new file `lib/db.ts` (or similar) that:
     - Imports `Pool` from "pg".
     - Exports a singleton `pool` using `process.env.DATABASE_URL`.
     - If `DATABASE_URL` is missing, throw a clear error.
   - Use standard `Pool` and `pool.query(...)`.

2. CREATE USER & CREDIT TABLES (SQL)
   - Create a migration SQL file or a `schema.sql` file in the repo with tables:
     - `users`:
       - id serial primary key
       - email text unique not null
       - password_hash text not null
       - role text not null default 'user'
       - credits integer not null default 0
       - stripe_customer_id text
       - created_at timestamptz default now()
     - `credit_transactions`:
       - id serial primary key
       - user_id integer not null references users(id)
       - amount integer not null
       - reason text not null
       - created_at timestamptz default now()
   - Do NOT wire migrations automatically; Iâ€™ll run them manually once I have a DB. Just ensure the SQL is present and correct.

3. MIGRATE AUTH FROM IN-MEMORY TO POSTGRES
   - Find the current in-memory user store used for registration/login.
   - Replace it with DB-based functions, e.g. in `lib/users.ts`:
     - `getUserByEmail(email: string)`
     - `createUser(email: string, passwordHash: string, role: "user" | "admin")`
     - `getUserById(id: number)`
   - In the auth API routes (e.g. `pages/api/auth/register.ts`, `pages/api/auth/login.ts`):
     - On register:
       - Insert into `users` (with `credits = 0` by default).
     - On login:
       - Look up user from DB by email, verify password, then sign a JWT that includes at least:
         - `userId`
         - `role`
         - `email`

4. ADD CREDITS FIELD LOGIC
   - In `lib/users.ts`, add helpers:
     - `addCredits(userId: number, amount: number, reason: string)`
       - Use a transaction to:
         - UPDATE users SET credits = credits + $1 WHERE id = $2
         - INSERT INTO credit_transactions (user_id, amount, reason) VALUES ($2, $1, $3)
     - `getUserWithCredits(userId: number)` that returns user row including `credits`.

5. UPDATE /api/generate TO USE CREDITS FOR LOGGED-IN USERS
   - In `pages/api/generate.ts`:
     - First, parse cookies to get the JWT (same as now).
     - If **no valid JWT**:
       - Keep the existing "1 free use" logic for anonymous visitors (using the cookie flag).
     - If JWT is valid and contains `userId`:
       - Load the user from DB using `getUserWithCredits(userId)`.
       - If `role` is "admin":
         - Allow unlimited generations (no credit decrement).
       - If `role` is "user":
         - If `credits <= 0`, return a JSON error:
           - `{ ok: false, error: "no_credits", message: "You have no credits left. Please buy a pack." }`
         - Else:
           - Before calling OpenAI, run `addCredits(userId, -1, "generation")`.
           - Then call OpenAI as before and return `{ ok: true, output }`.

6. KEEP EXISTING UI BEHAVIOR
   - Do NOT change the overall UI structure:
     - 4 tabs (Cold Email, Proposal, Contract, Social Pack).
     - Generate button that calls /api/generate.
   - Optionally, you may add a simple "Credits: X" display in the React UI by calling a small `/api/me` endpoint, but this is optional right now; prioritize getting the backend correct.

7. CLEANUP & SUMMARY
   - Remove any in-memory user store or arrays used previously for auth.
   - Make sure `npm run dev` and `npm run build` work assuming `DATABASE_URL` is set.
   - At the end, summarize:
     - Which files you created/modified.
     - The SQL schema for users and credit_transactions.
     - How /api/generate now checks and decrements credits.

Do not remove or break the OpenAI /api/generate logic. We are only adding real users with credits via PostgreSQL, and enforcing credit usage for logged-in users.
