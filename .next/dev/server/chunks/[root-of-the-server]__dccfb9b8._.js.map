{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 44, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nif (!process.env.DATABASE_URL) {\n  throw new Error('DATABASE_URL environment variable is required');\n}\n\nexport const pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : undefined,\n});\n\npool.on('error', (err) => {\n  console.error('Unexpected error on idle client', err);\n});\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MAAM;AAClB;AAEO,MAAM,OAAO,IAAI,4GAAI,CAAC;IAC3B,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,QAAQ,KAAK,CAAC,mCAAmC;AACnD"}},
    {"offset": {"line": 71, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/users.ts"],"sourcesContent":["import bcrypt from 'bcryptjs';\nimport { sign, verify } from 'jsonwebtoken';\nimport { pool } from './db';\n\nexport type UserRole = 'user' | 'admin';\n\nexport interface User {\n  id: string;\n  email: string;\n  password_hash: string | null;\n  role: UserRole;\n  credits: number;\n  is_admin: boolean;\n  usage_count: number;\n  stripe_customer_id: string | null;\n  created_at: Date;\n}\n\nexport interface UserWithoutPassword {\n  id: string;\n  email: string;\n  role: UserRole;\n  credits: number;\n  is_admin: boolean;\n  usage_count: number;\n}\n\nexport interface JWTPayload {\n  userId: string;\n  email: string;\n  role: UserRole;\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || process.env.SESSION_SECRET || 'bizkit-dev-secret';\nconst SUPER_USER_EMAIL = process.env.SUPER_USER_EMAIL;\nconst BCRYPT_ROUNDS = 10;\n\nasync function hashPassword(password: string): Promise<string> {\n  return bcrypt.hash(password, BCRYPT_ROUNDS);\n}\n\nasync function comparePassword(password: string, hash: string): Promise<boolean> {\n  return bcrypt.compare(password, hash);\n}\n\nexport function isUserSuperUser(email: string): boolean {\n  if (!SUPER_USER_EMAIL) return false;\n  return email.toLowerCase().trim() === SUPER_USER_EMAIL.toLowerCase().trim();\n}\n\nexport async function getUserByEmail(email: string): Promise<User | null> {\n  const normalizedEmail = email.toLowerCase().trim();\n  const result = await pool.query(\n    'SELECT * FROM users WHERE LOWER(email) = $1',\n    [normalizedEmail]\n  );\n  return result.rows[0] || null;\n}\n\nexport async function getUserById(id: string): Promise<User | null> {\n  const result = await pool.query(\n    'SELECT * FROM users WHERE id = $1',\n    [id]\n  );\n  return result.rows[0] || null;\n}\n\nexport async function getUserWithCredits(userId: string): Promise<UserWithoutPassword | null> {\n  const result = await pool.query(\n    'SELECT id, email, role, credits, is_admin, usage_count FROM users WHERE id = $1',\n    [userId]\n  );\n  if (!result.rows[0]) return null;\n  \n  const user = result.rows[0];\n  return {\n    id: user.id,\n    email: user.email,\n    role: user.is_admin ? 'admin' : (user.role || 'user'),\n    credits: user.credits || 0,\n    is_admin: user.is_admin || false,\n    usage_count: user.usage_count || 0,\n  };\n}\n\nexport async function createUser(\n  email: string, \n  password: string, \n  role: UserRole = 'user'\n): Promise<User | { error: string }> {\n  const normalizedEmail = email.toLowerCase().trim();\n  \n  const existing = await getUserByEmail(normalizedEmail);\n  if (existing) {\n    return { error: 'User already exists' };\n  }\n  \n  const passwordHash = await hashPassword(password);\n  const isSuperUser = isUserSuperUser(normalizedEmail);\n  const finalRole = isSuperUser ? 'admin' : role;\n  \n  try {\n    const result = await pool.query(\n      `INSERT INTO users (email, password_hash, role, credits, is_admin, usage_count, created_at, updated_at)\n       VALUES ($1, $2, $3, $4, $5, 0, NOW(), NOW())\n       RETURNING *`,\n      [normalizedEmail, passwordHash, finalRole, 0, isSuperUser]\n    );\n    return result.rows[0];\n  } catch (error: any) {\n    if (error.code === '23505') {\n      return { error: 'User already exists' };\n    }\n    throw error;\n  }\n}\n\nexport async function validatePassword(user: User, password: string): Promise<boolean> {\n  if (!user.password_hash) return false;\n  return comparePassword(password, user.password_hash);\n}\n\nexport async function loginUser(\n  email: string, \n  password: string\n): Promise<{ token: string; user: UserWithoutPassword } | { error: string }> {\n  const normalizedEmail = email.toLowerCase().trim();\n  \n  const user = await getUserByEmail(normalizedEmail);\n  if (!user) {\n    return { error: 'Invalid email or password' };\n  }\n  \n  if (!user.password_hash) {\n    return { error: 'Invalid email or password' };\n  }\n  \n  const isValid = await validatePassword(user, password);\n  if (!isValid) {\n    return { error: 'Invalid email or password' };\n  }\n  \n  const isSuperUser = isUserSuperUser(normalizedEmail);\n  const finalRole: UserRole = isSuperUser || user.is_admin ? 'admin' : (user.role as UserRole || 'user');\n  \n  if (isSuperUser && !user.is_admin) {\n    await pool.query('UPDATE users SET is_admin = true, role = $1 WHERE id = $2', ['admin', user.id]);\n  }\n  \n  const token = generateToken({\n    userId: user.id,\n    email: user.email,\n    role: finalRole,\n  });\n  \n  return {\n    token,\n    user: {\n      id: user.id,\n      email: user.email,\n      role: finalRole,\n      credits: user.credits || 0,\n      is_admin: isSuperUser || user.is_admin || false,\n      usage_count: user.usage_count || 0,\n    },\n  };\n}\n\nexport function generateToken(payload: JWTPayload): string {\n  return sign(payload, JWT_SECRET, { expiresIn: '7d' });\n}\n\nexport function verifyToken(token: string): JWTPayload | null {\n  try {\n    return verify(token, JWT_SECRET) as JWTPayload;\n  } catch {\n    return null;\n  }\n}\n\nexport function getTokenFromCookie(cookieHeader: string | undefined): string | null {\n  if (!cookieHeader) return null;\n  \n  const cookies = cookieHeader.split(';').reduce((acc, cookie) => {\n    const [key, value] = cookie.trim().split('=');\n    acc[key] = value;\n    return acc;\n  }, {} as Record<string, string>);\n  \n  return cookies.bizkit_token || null;\n}\n\nexport function getUserFromRequest(cookieHeader: string | undefined): JWTPayload | null {\n  const token = getTokenFromCookie(cookieHeader);\n  if (!token) return null;\n  return verifyToken(token);\n}\n\nexport async function addCredits(\n  userId: string, \n  amount: number, \n  reason: string\n): Promise<boolean> {\n  const client = await pool.connect();\n  try {\n    await client.query('BEGIN');\n    \n    await client.query(\n      'UPDATE users SET credits = credits + $1 WHERE id = $2',\n      [amount, userId]\n    );\n    \n    await client.query(\n      'INSERT INTO credit_transactions (user_id, amount, reason, created_at) VALUES ($1, $2, $3, NOW())',\n      [userId, amount, reason]\n    );\n    \n    await client.query('COMMIT');\n    return true;\n  } catch (error) {\n    await client.query('ROLLBACK');\n    console.error('Failed to add credits:', error);\n    return false;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function incrementUserUsage(userId: string): Promise<number> {\n  const result = await pool.query(\n    'UPDATE users SET usage_count = COALESCE(usage_count, 0) + 1 WHERE id = $1 RETURNING usage_count',\n    [userId]\n  );\n  return result.rows[0]?.usage_count || 0;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 292, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/pages/api/auth/me.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\nimport { getUserFromRequest, getUserWithCredits } from '../../../lib/users';\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== 'GET') {\n    return res.status(405).json({ ok: false, error: 'Method not allowed' });\n  }\n\n  try {\n    const jwtPayload = getUserFromRequest(req.headers.cookie);\n\n    if (!jwtPayload) {\n      return res.status(200).json({ ok: true, user: null });\n    }\n\n    const user = await getUserWithCredits(jwtPayload.userId);\n\n    if (!user) {\n      return res.status(200).json({ \n        ok: true, \n        user: {\n          id: jwtPayload.userId,\n          email: jwtPayload.email,\n          role: jwtPayload.role,\n          credits: 0,\n        }\n      });\n    }\n\n    return res.status(200).json({ \n      ok: true, \n      user,\n    });\n  } catch (error) {\n    console.error('Get user error:', error);\n    return res.status(500).json({ ok: false, error: 'Internal server error' });\n  }\n}\n"],"names":[],"mappings":";;;;AACA;;;;;;AAEe,eAAe,QAAQ,GAAmB,EAAE,GAAoB;IAC7E,IAAI,IAAI,MAAM,KAAK,OAAO;QACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAqB;IACvE;IAEA,IAAI;QACF,MAAM,aAAa,IAAA,2HAAkB,EAAC,IAAI,OAAO,CAAC,MAAM;QAExD,IAAI,CAAC,YAAY;YACf,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,IAAI;gBAAM,MAAM;YAAK;QACrD;QAEA,MAAM,OAAO,MAAM,IAAA,2HAAkB,EAAC,WAAW,MAAM;QAEvD,IAAI,CAAC,MAAM;YACT,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,IAAI;gBACJ,MAAM;oBACJ,IAAI,WAAW,MAAM;oBACrB,OAAO,WAAW,KAAK;oBACvB,MAAM,WAAW,IAAI;oBACrB,SAAS;gBACX;YACF;QACF;QAEA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAC1B,IAAI;YACJ;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mBAAmB;QACjC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAwB;IAC1E;AACF"}}]
}