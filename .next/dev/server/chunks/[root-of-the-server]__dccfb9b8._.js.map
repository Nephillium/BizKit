{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 44, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nlet connectionString = process.env.DATABASE_URL || '';\nif (connectionString.startsWith(\"psql \")) {\n  connectionString = connectionString.replace(\"psql \", \"\").replace(/^'|'$/g, \"\");\n}\n\nconst pool = new Pool({\n  connectionString,\n  ssl: { rejectUnauthorized: false },\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,IAAI,mBAAmB,QAAQ,GAAG,CAAC,YAAY,IAAI;AACnD,IAAI,iBAAiB,UAAU,CAAC,UAAU;IACxC,mBAAmB,iBAAiB,OAAO,CAAC,SAAS,IAAI,OAAO,CAAC,UAAU;AAC7E;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB;IACA,KAAK;QAAE,oBAAoB;IAAM;AACnC;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/users.ts"],"sourcesContent":["import bcrypt from 'bcryptjs';\nimport { sign, verify } from 'jsonwebtoken';\nimport { query, queryOne, pool } from './db';\n\nexport type UserRole = 'user' | 'admin';\n\nexport interface User {\n  id: string;\n  email: string;\n  password_hash: string;\n  role: UserRole;\n  credits: number;\n  usage_count: number;\n  created_at: Date;\n}\n\nexport interface JWTPayload {\n  id: string;\n  email: string;\n  role: UserRole;\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || process.env.SESSION_SECRET || 'bizkit-dev-secret';\nconst SUPER_USER_EMAIL = process.env.SUPER_USER_EMAIL;\nconst SALT_ROUNDS = 10;\n\nasync function hashPassword(password: string): Promise<string> {\n  return bcrypt.hash(password, SALT_ROUNDS);\n}\n\nasync function verifyPassword(password: string, hash: string): Promise<boolean> {\n  return bcrypt.compare(password, hash);\n}\n\nexport function isUserSuperUser(email: string): boolean {\n  if (!SUPER_USER_EMAIL) return false;\n  return email.toLowerCase().trim() === SUPER_USER_EMAIL.toLowerCase().trim();\n}\n\nexport async function findUserByEmail(email: string): Promise<User | null> {\n  return queryOne<User>(\n    'SELECT id, email, password_hash, role, credits, usage_count, created_at FROM users WHERE email = $1',\n    [email.toLowerCase().trim()]\n  );\n}\n\nexport async function findUserById(id: string): Promise<User | null> {\n  return queryOne<User>(\n    'SELECT id, email, password_hash, role, credits, usage_count, created_at FROM users WHERE id = $1',\n    [id]\n  );\n}\n\nexport async function registerUser(\n  email: string, \n  password: string\n): Promise<User | { error: string }> {\n  const normalizedEmail = email.toLowerCase().trim();\n  \n  const existing = await findUserByEmail(normalizedEmail);\n  if (existing) {\n    return { error: 'User already exists' };\n  }\n  \n  const passwordHash = await hashPassword(password);\n  const role: UserRole = isUserSuperUser(normalizedEmail) ? 'admin' : 'user';\n  \n  const result = await queryOne<User>(\n    `INSERT INTO users (email, password_hash, role, credits, usage_count) \n     VALUES ($1, $2, $3, $4, $5) \n     RETURNING id, email, password_hash, role, credits, usage_count, created_at`,\n    [normalizedEmail, passwordHash, role, 0, 0]\n  );\n  \n  if (!result) {\n    return { error: 'Failed to create user' };\n  }\n  \n  return result;\n}\n\nexport async function loginUser(\n  email: string, \n  password: string\n): Promise<{ token: string; user: Omit<User, 'password_hash'> } | { error: string }> {\n  const normalizedEmail = email.toLowerCase().trim();\n  \n  const user = await findUserByEmail(normalizedEmail);\n  if (!user) {\n    return { error: 'Invalid email or password' };\n  }\n  \n  const valid = await verifyPassword(password, user.password_hash);\n  if (!valid) {\n    return { error: 'Invalid email or password' };\n  }\n  \n  let role = user.role;\n  if (isUserSuperUser(normalizedEmail) && role !== 'admin') {\n    await query('UPDATE users SET role = $1 WHERE id = $2', ['admin', user.id]);\n    role = 'admin';\n  }\n  \n  const token = generateToken({ ...user, role });\n  const { password_hash, ...userWithoutPassword } = { ...user, role };\n  return { token, user: userWithoutPassword };\n}\n\nexport function generateToken(user: { id: string; email: string; role: UserRole }): string {\n  const payload: JWTPayload = {\n    id: user.id,\n    email: user.email,\n    role: user.role,\n  };\n  return sign(payload, JWT_SECRET, { expiresIn: '7d' });\n}\n\nexport function verifyToken(token: string): JWTPayload | null {\n  try {\n    return verify(token, JWT_SECRET) as JWTPayload;\n  } catch {\n    return null;\n  }\n}\n\nexport function getTokenFromCookie(cookieHeader: string | undefined): string | null {\n  if (!cookieHeader) return null;\n  \n  const cookies = cookieHeader.split(';').reduce((acc, cookie) => {\n    const [key, value] = cookie.trim().split('=');\n    acc[key] = value;\n    return acc;\n  }, {} as Record<string, string>);\n  \n  return cookies.bizkit_token || null;\n}\n\nexport function getUserFromRequest(cookieHeader: string | undefined, authHeader?: string | undefined): JWTPayload | null {\n  // First try Authorization header (for mobile apps)\n  if (authHeader && authHeader.startsWith('Bearer ')) {\n    const token = authHeader.substring(7);\n    const payload = verifyToken(token);\n    if (payload) return payload;\n  }\n  \n  // Fall back to cookie (for web app)\n  const token = getTokenFromCookie(cookieHeader);\n  if (!token) return null;\n  return verifyToken(token);\n}\n\nexport async function getUserCredits(userId: string): Promise<number> {\n  const user = await findUserById(userId);\n  return user?.credits ?? 0;\n}\n\nexport async function addCredits(\n  userId: string, \n  amount: number, \n  reason: string\n): Promise<boolean> {\n  const client = await pool.connect();\n  try {\n    await client.query('BEGIN');\n    \n    const result = await client.query(\n      'UPDATE users SET credits = credits + $1 WHERE id = $2 RETURNING credits',\n      [amount, userId]\n    );\n    \n    if (result.rowCount === 0) {\n      await client.query('ROLLBACK');\n      return false;\n    }\n    \n    await client.query(\n      'INSERT INTO credit_transactions (user_id, amount, reason) VALUES ($1, $2, $3)',\n      [userId, amount, reason]\n    );\n    \n    await client.query('COMMIT');\n    return true;\n  } catch (error) {\n    await client.query('ROLLBACK');\n    console.error('Failed to add credits:', error);\n    return false;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function incrementUserUsage(userId: string): Promise<number> {\n  const result = await queryOne<{ usage_count: number }>(\n    'UPDATE users SET usage_count = usage_count + 1 WHERE id = $1 RETURNING usage_count',\n    [userId]\n  );\n  return result?.usage_count ?? 0;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 303, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/pages/api/auth/me.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\nimport { getUserFromRequest, findUserById } from '../../../lib/users';\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== 'GET') {\n    return res.status(405).json({ ok: false, error: 'Method not allowed' });\n  }\n\n  const jwtPayload = getUserFromRequest(req.headers.cookie, req.headers.authorization);\n\n  if (!jwtPayload) {\n    return res.status(401).json({ ok: false, user: null, error: 'Not authenticated' });\n  }\n\n  const user = await findUserById(jwtPayload.id);\n\n  if (!user) {\n    return res.status(200).json({ \n      ok: true, \n      user: {\n        id: jwtPayload.id,\n        email: jwtPayload.email,\n        role: jwtPayload.role,\n      }\n    });\n  }\n\n  const { password_hash, ...userWithoutPassword } = user;\n  \n  return res.status(200).json({ \n    ok: true, \n    user: userWithoutPassword,\n  });\n}\n"],"names":[],"mappings":";;;;AACA;;;;;;AAEe,eAAe,QAAQ,GAAmB,EAAE,GAAoB;IAC7E,IAAI,IAAI,MAAM,KAAK,OAAO;QACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAqB;IACvE;IAEA,MAAM,aAAa,IAAA,2HAAkB,EAAC,IAAI,OAAO,CAAC,MAAM,EAAE,IAAI,OAAO,CAAC,aAAa;IAEnF,IAAI,CAAC,YAAY;QACf,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,MAAM;YAAM,OAAO;QAAoB;IAClF;IAEA,MAAM,OAAO,MAAM,IAAA,qHAAY,EAAC,WAAW,EAAE;IAE7C,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAC1B,IAAI;YACJ,MAAM;gBACJ,IAAI,WAAW,EAAE;gBACjB,OAAO,WAAW,KAAK;gBACvB,MAAM,WAAW,IAAI;YACvB;QACF;IACF;IAEA,MAAM,EAAE,aAAa,EAAE,GAAG,qBAAqB,GAAG;IAElD,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAC1B,IAAI;QACJ,MAAM;IACR;AACF"}}]
}