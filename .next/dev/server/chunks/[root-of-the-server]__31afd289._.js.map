{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/usersStore.ts"],"sourcesContent":["import { createHash } from 'crypto';\nimport { sign, verify } from 'jsonwebtoken';\n\nexport type UserRole = 'user' | 'admin';\n\nexport interface User {\n  id: string;\n  email: string;\n  passwordHash: string;\n  role: UserRole;\n  usageCount: number;\n  createdAt: Date;\n}\n\nexport interface JWTPayload {\n  id: string;\n  email: string;\n  role: UserRole;\n}\n\nconst users: Map<string, User> = new Map();\n\nconst JWT_SECRET = process.env.JWT_SECRET || process.env.SESSION_SECRET || 'bizkit-dev-secret';\nconst SUPER_USER_EMAIL = process.env.SUPER_USER_EMAIL;\n\nfunction hashPassword(password: string): string {\n  return createHash('sha256').update(password).digest('hex');\n}\n\nfunction generateId(): string {\n  return `user_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\n}\n\nexport function registerUser(email: string, password: string, role: UserRole = 'user'): User | { error: string } {\n  const normalizedEmail = email.toLowerCase().trim();\n  \n  if (users.has(normalizedEmail)) {\n    return { error: 'User already exists' };\n  }\n  \n  const user: User = {\n    id: generateId(),\n    email: normalizedEmail,\n    passwordHash: hashPassword(password),\n    role,\n    usageCount: 0,\n    createdAt: new Date(),\n  };\n  \n  users.set(normalizedEmail, user);\n  return user;\n}\n\nexport function findUserByEmail(email: string): User | undefined {\n  return users.get(email.toLowerCase().trim());\n}\n\nexport function findUserById(id: string): User | undefined {\n  for (const user of users.values()) {\n    if (user.id === id) {\n      return user;\n    }\n  }\n  return undefined;\n}\n\nexport function validatePassword(user: User, password: string): boolean {\n  return user.passwordHash === hashPassword(password);\n}\n\nexport function incrementUserUsage(email: string): number {\n  const user = findUserByEmail(email);\n  if (user) {\n    user.usageCount += 1;\n    return user.usageCount;\n  }\n  return 0;\n}\n\nexport function isUserSuperUser(email: string): boolean {\n  if (!SUPER_USER_EMAIL) return false;\n  return email.toLowerCase().trim() === SUPER_USER_EMAIL.toLowerCase().trim();\n}\n\nexport function loginUser(email: string, password: string): { token: string; user: Omit<User, 'passwordHash'> } | { error: string } {\n  const normalizedEmail = email.toLowerCase().trim();\n  \n  const user = findUserByEmail(normalizedEmail);\n  if (!user) {\n    return { error: 'Invalid email or password' };\n  }\n  \n  if (!validatePassword(user, password)) {\n    return { error: 'Invalid email or password' };\n  }\n  \n  if (isUserSuperUser(normalizedEmail)) {\n    user.role = 'admin';\n  }\n  \n  const token = generateToken(user);\n  const { passwordHash, ...userWithoutPassword } = user;\n  return { token, user: userWithoutPassword };\n}\n\nexport function generateToken(user: User): string {\n  const payload: JWTPayload = {\n    id: user.id,\n    email: user.email,\n    role: user.role,\n  };\n  return sign(payload, JWT_SECRET, { expiresIn: '7d' });\n}\n\nexport function verifyToken(token: string): JWTPayload | null {\n  try {\n    return verify(token, JWT_SECRET) as JWTPayload;\n  } catch {\n    return null;\n  }\n}\n\nexport function getTokenFromCookie(cookieHeader: string | undefined): string | null {\n  if (!cookieHeader) return null;\n  \n  const cookies = cookieHeader.split(';').reduce((acc, cookie) => {\n    const [key, value] = cookie.trim().split('=');\n    acc[key] = value;\n    return acc;\n  }, {} as Record<string, string>);\n  \n  return cookies.bizkit_token || null;\n}\n\nexport function getUserFromRequest(cookieHeader: string | undefined): JWTPayload | null {\n  const token = getTokenFromCookie(cookieHeader);\n  if (!token) return null;\n  return verifyToken(token);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 173, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/pages/api/auth/register.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\nimport { registerUser, generateToken } from '../../../lib/usersStore';\nimport { serialize } from 'cookie';\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== 'POST') {\n    return res.status(405).json({ ok: false, error: 'Method not allowed' });\n  }\n\n  const { email, password } = req.body;\n\n  if (!email || !password) {\n    return res.status(400).json({ ok: false, error: 'Email and password are required' });\n  }\n\n  if (password.length < 4) {\n    return res.status(400).json({ ok: false, error: 'Password must be at least 4 characters' });\n  }\n\n  const result = registerUser(email, password, 'user');\n\n  if ('error' in result) {\n    return res.status(400).json({ ok: false, error: result.error });\n  }\n\n  const token = generateToken(result);\n  \n  res.setHeader('Set-Cookie', serialize('bizkit_token', token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24 * 7,\n    path: '/',\n  }));\n\n  const { passwordHash, ...userWithoutPassword } = result;\n  \n  return res.status(200).json({ \n    ok: true, \n    user: userWithoutPassword,\n  });\n}\n"],"names":[],"mappings":";;;;AACA;AACA;;;AAEe,eAAe,QAAQ,GAAmB,EAAE,GAAoB;IAC7E,IAAI,IAAI,MAAM,KAAK,QAAQ;QACzB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAqB;IACvE;IAEA,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,IAAI,IAAI;IAEpC,IAAI,CAAC,SAAS,CAAC,UAAU;QACvB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAkC;IACpF;IAEA,IAAI,SAAS,MAAM,GAAG,GAAG;QACvB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAyC;IAC3F;IAEA,MAAM,SAAS,IAAA,0HAAY,EAAC,OAAO,UAAU;IAE7C,IAAI,WAAW,QAAQ;QACrB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO,OAAO,KAAK;QAAC;IAC/D;IAEA,MAAM,QAAQ,IAAA,2HAAa,EAAC;IAE5B,IAAI,SAAS,CAAC,cAAc,IAAA,kHAAS,EAAC,gBAAgB,OAAO;QAC3D,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,KAAK,KAAK,KAAK;QACvB,MAAM;IACR;IAEA,MAAM,EAAE,YAAY,EAAE,GAAG,qBAAqB,GAAG;IAEjD,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAC1B,IAAI;QACJ,MAAM;IACR;AACF"}}]
}