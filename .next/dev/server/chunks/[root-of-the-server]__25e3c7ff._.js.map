{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 80, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/shared/schema.ts"],"sourcesContent":["import { sql } from 'drizzle-orm';\nimport {\n  index,\n  jsonb,\n  pgTable,\n  timestamp,\n  varchar,\n  text,\n  serial,\n  boolean,\n  integer,\n} from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Session storage table.\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// User storage table.\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  isAdmin: boolean(\"is_admin\").default(false),\n  isSubscribed: boolean(\"is_subscribed\").default(false),\n  stripeCustomerId: varchar(\"stripe_customer_id\"),\n  stripeSubscriptionId: varchar(\"stripe_subscription_id\"),\n  usageCount: integer(\"usage_count\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\n\n// Anonymous usage tracking (by fingerprint/IP)\nexport const anonymousUsage = pgTable(\"anonymous_usage\", {\n  id: serial(\"id\").primaryKey(),\n  fingerprint: varchar(\"fingerprint\").notNull().unique(),\n  usageCount: integer(\"usage_count\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport type AnonymousUsage = typeof anonymousUsage.$inferSelect;\n\n// Generation history table for storing user's past generations\nexport const generations = pgTable(\"generations\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  toolType: varchar(\"tool_type\", { length: 50 }).notNull(),\n  inputs: jsonb(\"inputs\").notNull(),\n  output: text(\"output\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertGenerationSchema = createInsertSchema(generations).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertGeneration = z.infer<typeof insertGenerationSchema>;\nexport type Generation = typeof generations.$inferSelect;\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;AAWA;;;;;;;;;;AAKO,MAAM,WAAW,IAAA,mKAAO,EAC7B,YACA;IACE,KAAK,IAAA,mKAAO,EAAC,OAAO,UAAU;IAC9B,MAAM,IAAA,iKAAK,EAAC,QAAQ,OAAO;IAC3B,QAAQ,IAAA,qKAAS,EAAC,UAAU,OAAO;AACrC,GACA,CAAC,QAAU;QAAC,IAAA,iKAAK,EAAC,sBAAsB,EAAE,CAAC,MAAM,MAAM;KAAE;AAKpD,MAAM,QAAQ,IAAA,mKAAO,EAAC,SAAS;IACpC,IAAI,IAAA,mKAAO,EAAC,MAAM,UAAU,GAAG,OAAO,CAAC,mIAAG,CAAC,iBAAiB,CAAC;IAC7D,OAAO,IAAA,mKAAO,EAAC,SAAS,MAAM;IAC9B,WAAW,IAAA,mKAAO,EAAC;IACnB,UAAU,IAAA,mKAAO,EAAC;IAClB,iBAAiB,IAAA,mKAAO,EAAC;IACzB,SAAS,IAAA,mKAAO,EAAC,YAAY,OAAO,CAAC;IACrC,cAAc,IAAA,mKAAO,EAAC,iBAAiB,OAAO,CAAC;IAC/C,kBAAkB,IAAA,mKAAO,EAAC;IAC1B,sBAAsB,IAAA,mKAAO,EAAC;IAC9B,YAAY,IAAA,mKAAO,EAAC,eAAe,OAAO,CAAC;IAC3C,WAAW,IAAA,qKAAS,EAAC,cAAc,UAAU;IAC7C,WAAW,IAAA,qKAAS,EAAC,cAAc,UAAU;AAC/C;AAMO,MAAM,iBAAiB,IAAA,mKAAO,EAAC,mBAAmB;IACvD,IAAI,IAAA,kKAAM,EAAC,MAAM,UAAU;IAC3B,aAAa,IAAA,mKAAO,EAAC,eAAe,OAAO,GAAG,MAAM;IACpD,YAAY,IAAA,mKAAO,EAAC,eAAe,OAAO,CAAC;IAC3C,WAAW,IAAA,qKAAS,EAAC,cAAc,UAAU;AAC/C;AAKO,MAAM,cAAc,IAAA,mKAAO,EAAC,eAAe;IAChD,IAAI,IAAA,kKAAM,EAAC,MAAM,UAAU;IAC3B,QAAQ,IAAA,mKAAO,EAAC,WAAW,OAAO,GAAG,UAAU,CAAC,IAAM,MAAM,EAAE;IAC9D,UAAU,IAAA,mKAAO,EAAC,aAAa;QAAE,QAAQ;IAAG,GAAG,OAAO;IACtD,QAAQ,IAAA,iKAAK,EAAC,UAAU,OAAO;IAC/B,QAAQ,IAAA,gKAAI,EAAC,UAAU,OAAO;IAC9B,WAAW,IAAA,qKAAS,EAAC,cAAc,UAAU;AAC/C;AAEO,MAAM,yBAAyB,IAAA,kJAAkB,EAAC,aAAa,IAAI,CAAC;IACzE,IAAI;IACJ,WAAW;AACb"}},
    {"offset": {"line": 172, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/server/db.ts"],"sourcesContent":["import { drizzle } from \"drizzle-orm/node-postgres\";\nimport pg from \"pg\";\nimport * as schema from \"../shared/schema\";\n\nconst { Pool } = pg;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle(pool, { schema });\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;;;;;;;AAEA,MAAM,EAAE,IAAI,EAAE,GAAG,+GAAE;AAEnB,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MACR;AAEJ;AAEO,MAAM,OAAO,IAAI,KAAK;IAAE,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAAC;AACnE,MAAM,KAAK,IAAA,+KAAO,EAAC,MAAM;IAAE,QAAA;AAAO"}},
    {"offset": {"line": 207, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/server/storage.ts"],"sourcesContent":["import {\n  users,\n  generations,\n  anonymousUsage,\n  type User,\n  type UpsertUser,\n  type Generation,\n  type InsertGeneration,\n  type AnonymousUsage,\n} from \"../shared/schema\";\nimport { db } from \"./db\";\nimport { eq, desc, sql } from \"drizzle-orm\";\n\n// Interface for storage operations\nexport interface IStorage {\n  // User operations (mandatory for Replit Auth)\n  getUser(id: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  incrementUserUsage(id: string): Promise<number>;\n  updateUserSubscription(id: string, isSubscribed: boolean, stripeCustomerId?: string, stripeSubscriptionId?: string): Promise<User>;\n  // Anonymous usage operations\n  getAnonymousUsage(fingerprint: string): Promise<AnonymousUsage | undefined>;\n  incrementAnonymousUsage(fingerprint: string): Promise<number>;\n  // Generation operations\n  createGeneration(generation: InsertGeneration): Promise<Generation>;\n  getGenerations(userId: string): Promise<Generation[]>;\n  getGeneration(id: number): Promise<Generation | undefined>;\n  deleteGeneration(id: number): Promise<void>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User operations (mandatory for Replit Auth)\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n\n  async incrementUserUsage(id: string): Promise<number> {\n    const [updated] = await db\n      .update(users)\n      .set({ \n        usageCount: sql`${users.usageCount} + 1`,\n        updatedAt: new Date() \n      })\n      .where(eq(users.id, id))\n      .returning();\n    return updated?.usageCount ?? 0;\n  }\n\n  async updateUserSubscription(\n    id: string, \n    isSubscribed: boolean, \n    stripeCustomerId?: string, \n    stripeSubscriptionId?: string\n  ): Promise<User> {\n    const [updated] = await db\n      .update(users)\n      .set({\n        isSubscribed,\n        stripeCustomerId,\n        stripeSubscriptionId,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Anonymous usage operations\n  async getAnonymousUsage(fingerprint: string): Promise<AnonymousUsage | undefined> {\n    const [usage] = await db\n      .select()\n      .from(anonymousUsage)\n      .where(eq(anonymousUsage.fingerprint, fingerprint));\n    return usage;\n  }\n\n  async incrementAnonymousUsage(fingerprint: string): Promise<number> {\n    const [result] = await db\n      .insert(anonymousUsage)\n      .values({ fingerprint, usageCount: 1 })\n      .onConflictDoUpdate({\n        target: anonymousUsage.fingerprint,\n        set: { usageCount: sql`${anonymousUsage.usageCount} + 1` },\n      })\n      .returning();\n    return result?.usageCount ?? 0;\n  }\n\n  // Generation operations\n  async createGeneration(generation: InsertGeneration): Promise<Generation> {\n    const [created] = await db.insert(generations).values(generation).returning();\n    return created;\n  }\n\n  async getGenerations(userId: string): Promise<Generation[]> {\n    return await db\n      .select()\n      .from(generations)\n      .where(eq(generations.userId, userId))\n      .orderBy(desc(generations.createdAt));\n  }\n\n  async getGeneration(id: number): Promise<Generation | undefined> {\n    const [generation] = await db\n      .select()\n      .from(generations)\n      .where(eq(generations.id, id));\n    return generation;\n  }\n\n  async deleteGeneration(id: number): Promise<void> {\n    await db.delete(generations).where(eq(generations.id, id));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 298, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/auth.ts"],"sourcesContent":["import * as client from \"openid-client\";\nimport memoize from \"memoizee\";\nimport { storage } from \"../server/storage\";\n\nexport const getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport async function upsertUser(claims: any) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport function getCallbackUrl(req: { headers: { host?: string }; url?: string }) {\n  const protocol = process.env.NODE_ENV === 'production' ? 'https' : 'http';\n  const host = req.headers.host || 'localhost:5000';\n  return `${protocol}://${host}/api/callback`;\n}\n\nexport function getBaseUrl(req: { headers: { host?: string } }) {\n  const protocol = process.env.NODE_ENV === 'production' ? 'https' : 'http';\n  const host = req.headers.host || 'localhost:5000';\n  return `${protocol}://${host}`;\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;;;;;;;;;AAEO,MAAM,gBAAgB,IAAA,oHAAO,EAClC;IACE,OAAO,MAAM,6IAAgB,CAC3B,IAAI,IAAI,QAAQ,GAAG,CAAC,UAAU,IAAI,4BAClC,QAAQ,GAAG,CAAC,OAAO;AAEvB,GACA;IAAE,QAAQ,OAAO;AAAK;AAGjB,eAAe,WAAW,MAAW;IAC1C,MAAM,qHAAO,CAAC,UAAU,CAAC;QACvB,IAAI,MAAM,CAAC,MAAM;QACjB,OAAO,MAAM,CAAC,QAAQ;QACtB,WAAW,MAAM,CAAC,aAAa;QAC/B,UAAU,MAAM,CAAC,YAAY;QAC7B,iBAAiB,MAAM,CAAC,oBAAoB;IAC9C;AACF;AAEO,SAAS,eAAe,GAAiD;IAC9E,MAAM,WAAW,sCAAwC,0BAAU;IACnE,MAAM,OAAO,IAAI,OAAO,CAAC,IAAI,IAAI;IACjC,OAAO,GAAG,SAAS,GAAG,EAAE,KAAK,aAAa,CAAC;AAC7C;AAEO,SAAS,WAAW,GAAmC;IAC5D,MAAM,WAAW,sCAAwC,0BAAU;IACnE,MAAM,OAAO,IAAI,OAAO,CAAC,IAAI,IAAI;IACjC,OAAO,GAAG,SAAS,GAAG,EAAE,MAAM;AAChC"}},
    {"offset": {"line": 350, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/session.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\nimport { parse } from 'cookie';\nimport * as client from \"openid-client\";\nimport { getOidcConfig } from './auth';\n\nexport interface UserSession {\n  claims: any;\n  access_token: string;\n  refresh_token?: string;\n  expires_at?: number;\n}\n\nexport function getSessionFromCookie(req: NextApiRequest): UserSession | null {\n  const cookies = parse(req.headers.cookie || '');\n  const sessionCookie = cookies.session;\n  \n  if (!sessionCookie) {\n    return null;\n  }\n  \n  try {\n    const sessionData = Buffer.from(sessionCookie, 'base64').toString('utf-8');\n    return JSON.parse(sessionData);\n  } catch {\n    return null;\n  }\n}\n\nexport async function validateSession(session: UserSession): Promise<boolean> {\n  if (!session || !session.expires_at) {\n    return false;\n  }\n  \n  const now = Math.floor(Date.now() / 1000);\n  if (now <= session.expires_at) {\n    return true;\n  }\n  \n  if (!session.refresh_token) {\n    return false;\n  }\n  \n  try {\n    const config = await getOidcConfig();\n    await client.refreshTokenGrant(config, session.refresh_token);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nexport type AuthHandler = (\n  req: NextApiRequest, \n  res: NextApiResponse, \n  session: UserSession\n) => Promise<void>;\n\nexport function withAuth(handler: AuthHandler) {\n  return async (req: NextApiRequest, res: NextApiResponse) => {\n    const session = getSessionFromCookie(req);\n    \n    if (!session) {\n      return res.status(401).json({ message: \"Unauthorized\" });\n    }\n    \n    const isValid = await validateSession(session);\n    if (!isValid) {\n      return res.status(401).json({ message: \"Unauthorized\" });\n    }\n    \n    return handler(req, res, session);\n  };\n}\n"],"names":[],"mappings":";;;;;;;;AACA;AACA;AACA;;;;;;;;;AASO,SAAS,qBAAqB,GAAmB;IACtD,MAAM,UAAU,IAAA,8GAAK,EAAC,IAAI,OAAO,CAAC,MAAM,IAAI;IAC5C,MAAM,gBAAgB,QAAQ,OAAO;IAErC,IAAI,CAAC,eAAe;QAClB,OAAO;IACT;IAEA,IAAI;QACF,MAAM,cAAc,OAAO,IAAI,CAAC,eAAe,UAAU,QAAQ,CAAC;QAClE,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,gBAAgB,OAAoB;IACxD,IAAI,CAAC,WAAW,CAAC,QAAQ,UAAU,EAAE;QACnC,OAAO;IACT;IAEA,MAAM,MAAM,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;IACpC,IAAI,OAAO,QAAQ,UAAU,EAAE;QAC7B,OAAO;IACT;IAEA,IAAI,CAAC,QAAQ,aAAa,EAAE;QAC1B,OAAO;IACT;IAEA,IAAI;QACF,MAAM,SAAS,MAAM,IAAA,qHAAa;QAClC,MAAM,qJAAwB,CAAC,QAAQ,QAAQ,aAAa;QAC5D,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAQO,SAAS,SAAS,OAAoB;IAC3C,OAAO,OAAO,KAAqB;QACjC,MAAM,UAAU,qBAAqB;QAErC,IAAI,CAAC,SAAS;YACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,SAAS;YAAe;QACxD;QAEA,MAAM,UAAU,MAAM,gBAAgB;QACtC,IAAI,CAAC,SAAS;YACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,SAAS;YAAe;QACxD;QAEA,OAAO,QAAQ,KAAK,KAAK;IAC3B;AACF"}},
    {"offset": {"line": 431, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/pages/api/generate.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next'\nimport OpenAI from 'openai'\nimport { parse, serialize } from 'cookie'\nimport { getSessionFromCookie, validateSession } from '../../lib/session'\nimport { storage } from '../../server/storage'\nimport { randomUUID } from 'crypto'\n\nconst FREE_USAGE_LIMIT = 1\n\ntype ModelOption = 'gpt-4o-mini' | 'gpt-4o'\ntype LengthOption = 'short' | 'standard' | 'detailed'\ntype Tool = 'cold_email' | 'proposal' | 'contract' | 'social_pack'\n\nconst MAX_TOKENS_MAP: Record<LengthOption, number> = {\n  short: 500,\n  standard: 1000,\n  detailed: 2000,\n}\n\ninterface ColdEmailInputs {\n  target: string\n  service: string\n  tone: string\n  language: string\n}\n\ninterface ProposalInputs {\n  clientType: string\n  projectScope: string\n  deliverables: string\n  budgetRange: string\n  language: string\n}\n\ninterface ContractInputs {\n  clientName: string\n  providerName: string\n  serviceDescription: string\n  paymentTerms: string\n  jurisdiction: string\n  language: string\n}\n\ninterface SocialPackInputs {\n  businessType: string\n  niche: string\n  tone: string\n  platform: string\n  language: string\n}\n\ntype Inputs = ColdEmailInputs | ProposalInputs | ContractInputs | SocialPackInputs\n\ninterface PremiumOptions {\n  model?: ModelOption\n  length?: LengthOption\n  creativity?: number // 0-100 maps to temperature 0-1\n  customInstructions?: string\n}\n\ninterface RequestBody {\n  tool: Tool\n  inputs: Inputs\n  premiumOptions?: PremiumOptions\n}\n\ninterface ApiResponse {\n  ok: boolean\n  output?: string\n  error?: string\n  usageCount?: number\n  usageLimit?: number\n  requiresSubscription?: boolean\n}\n\nfunction buildPrompts(tool: Tool, inputs: Inputs): { systemPrompt: string; userPrompt: string } {\n  switch (tool) {\n    case 'cold_email': {\n      const { target, service, tone, language } = inputs as ColdEmailInputs\n      return {\n        systemPrompt: 'You are an expert B2B sales copywriter.',\n        userPrompt: `Write 3 short cold email variants for the following:\n\nTarget audience: ${target || 'business owners'}\nService being offered: ${service || 'consulting services'}\nTone: ${tone || 'professional'}\nLanguage: ${language || 'English'}\n\nEach email should include:\n- A compelling subject line\n- A concise body (3-5 sentences max)\n\nReturn as a numbered list (1, 2, 3) with clear separation between each variant.`,\n      }\n    }\n\n    case 'proposal': {\n      const { clientType, projectScope, deliverables, budgetRange, language } = inputs as ProposalInputs\n      return {\n        systemPrompt: 'You are a professional consultant writing project proposals.',\n        userPrompt: `Write a professional project proposal with the following details:\n\nClient Type: ${clientType || 'business client'}\nProject Scope: ${projectScope || 'to be defined'}\nDeliverables: ${deliverables || 'to be defined'}\nBudget Range: ${budgetRange || 'to be discussed'}\nLanguage: ${language || 'English'}\n\nStructure the proposal with these sections:\n1. Introduction\n2. Understanding of Needs\n3. Scope of Work\n4. Deliverables\n5. Timeline\n6. Investment\n7. Next Steps\n\nMake it professional, clear, and persuasive.`,\n      }\n    }\n\n    case 'contract': {\n      const { clientName, providerName, serviceDescription, paymentTerms, jurisdiction, language } = inputs as ContractInputs\n      return {\n        systemPrompt: 'You draft simple, plain-language service agreements (not legal advice).',\n        userPrompt: `Draft a simple service agreement with the following details:\n\nClient Name: ${clientName || '[CLIENT NAME]'}\nProvider Name: ${providerName || '[PROVIDER NAME]'}\nService Description: ${serviceDescription || 'to be defined'}\nPayment Terms: ${paymentTerms || 'to be agreed'}\nJurisdiction: ${jurisdiction || 'to be specified'}\nLanguage: ${language || 'English'}\n\nInclude these clauses:\n1. Parties\n2. Services\n3. Term\n4. Fees and Payment\n5. Confidentiality\n6. Intellectual Property\n7. Termination\n8. Governing Law\n\nKeep it concise and in plain language. Add a disclaimer that this is not legal advice.`,\n      }\n    }\n\n    case 'social_pack': {\n      const { businessType, niche, tone, platform, language } = inputs as SocialPackInputs\n      return {\n        systemPrompt: 'You are a social media strategist.',\n        userPrompt: `Create 10 short social media post ideas for the following:\n\nBusiness Type: ${businessType || 'business'}\nNiche: ${niche || 'general'}\nTone: ${tone || 'friendly'}\nPlatform: ${platform || 'social media'}\nLanguage: ${language || 'English'}\n\nProvide 10 numbered post ideas (1-10) with captions ready to use.\nEach post should be engaging and appropriate for the specified platform.`,\n      }\n    }\n\n    default:\n      throw new Error(`Unknown tool: ${tool}`)\n  }\n}\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse<ApiResponse>\n) {\n  if (req.method !== 'POST') {\n    return res.status(405).json({ ok: false, error: 'method_not_allowed' })\n  }\n\n  // Support both Replit AI Integrations and standard OpenAI API key\n  const replitBaseURL = process.env.AI_INTEGRATIONS_OPENAI_BASE_URL\n  const replitApiKey = process.env.AI_INTEGRATIONS_OPENAI_API_KEY\n  const standardApiKey = process.env.OPENAI_API_KEY\n\n  // Use Replit AI Integrations if available, otherwise fall back to standard OpenAI\n  const useReplitIntegrations = replitBaseURL && replitApiKey\n  const apiKey = useReplitIntegrations ? replitApiKey : standardApiKey\n  const baseURL = useReplitIntegrations ? replitBaseURL : undefined\n\n  if (!apiKey) {\n    return res.status(500).json({ ok: false, error: 'missing_openai_key' })\n  }\n\n  // Check usage limits\n  let userId: string | null = null\n  let isAdmin = false\n  let isSubscribed = false\n  let currentUsage = 0\n\n  // Check if user is logged in\n  const session = getSessionFromCookie(req)\n  if (session) {\n    const isValid = await validateSession(session)\n    if (isValid && session.claims?.sub) {\n      userId = session.claims.sub as string\n      const user = await storage.getUser(userId)\n      if (user) {\n        isAdmin = user.isAdmin ?? false\n        isSubscribed = user.isSubscribed ?? false\n        currentUsage = user.usageCount ?? 0\n      }\n    }\n  }\n\n  // Get or create anonymous fingerprint for non-logged-in users\n  let anonFingerprint: string | null = null\n  if (!userId) {\n    const cookies = parse(req.headers.cookie || '')\n    anonFingerprint = cookies.anon_id || null\n    \n    if (!anonFingerprint) {\n      anonFingerprint = randomUUID()\n      res.setHeader('Set-Cookie', serialize('anon_id', anonFingerprint, {\n        httpOnly: true,\n        secure: process.env.NODE_ENV === 'production',\n        sameSite: 'lax',\n        maxAge: 60 * 60 * 24 * 365, // 1 year\n        path: '/',\n      }))\n    }\n    \n    const anonUsage = await storage.getAnonymousUsage(anonFingerprint)\n    currentUsage = anonUsage?.usageCount ?? 0\n  }\n\n  // Check if user can generate (admins and subscribers bypass limits)\n  const canGenerate = isAdmin || isSubscribed || currentUsage < FREE_USAGE_LIMIT\n\n  if (!canGenerate) {\n    return res.status(403).json({ \n      ok: false, \n      error: 'usage_limit_exceeded',\n      usageCount: currentUsage,\n      usageLimit: FREE_USAGE_LIMIT,\n      requiresSubscription: true,\n    })\n  }\n\n  try {\n    const { tool, inputs, premiumOptions } = req.body as RequestBody\n\n    if (!tool || !inputs) {\n      return res.status(400).json({ ok: false, error: 'invalid_request' })\n    }\n\n    // Premium options with defaults\n    const model: ModelOption = premiumOptions?.model || 'gpt-4o-mini'\n    const length: LengthOption = premiumOptions?.length || 'standard'\n    const creativity = premiumOptions?.creativity ?? 50 // 0-100 scale\n    const customInstructions = premiumOptions?.customInstructions || ''\n\n    // Convert creativity (0-100) to temperature (0-1)\n    const temperature = Math.min(Math.max(creativity / 100, 0), 1)\n    const maxTokens = MAX_TOKENS_MAP[length]\n\n    const { systemPrompt, userPrompt } = buildPrompts(tool, inputs)\n\n    // Add custom instructions to system prompt if provided\n    const finalSystemPrompt = customInstructions\n      ? `${systemPrompt}\\n\\nAdditional Instructions from User:\\n${customInstructions}`\n      : systemPrompt\n\n    const openai = new OpenAI({\n      ...(baseURL && { baseURL }),\n      apiKey,\n    })\n\n    const response = await openai.chat.completions.create({\n      model,\n      messages: [\n        { role: 'system', content: finalSystemPrompt },\n        { role: 'user', content: userPrompt },\n      ],\n      max_tokens: maxTokens,\n      temperature,\n    })\n\n    const content = response.choices[0]?.message?.content || ''\n\n    // Increment usage count after successful generation\n    let newUsageCount = currentUsage\n    if (!isAdmin && !isSubscribed) {\n      if (userId) {\n        newUsageCount = await storage.incrementUserUsage(userId)\n      } else if (anonFingerprint) {\n        newUsageCount = await storage.incrementAnonymousUsage(anonFingerprint)\n      }\n    }\n\n    return res.status(200).json({ \n      ok: true, \n      output: content,\n      usageCount: newUsageCount,\n      usageLimit: FREE_USAGE_LIMIT,\n    })\n  } catch (error: any) {\n    console.error('OpenAI API Error:', error)\n\n    const errorMessage = error?.message || String(error)\n    const errorCode = error?.code || ''\n\n    if (\n      errorMessage.includes('429') ||\n      errorMessage.includes('insufficient_quota') ||\n      errorCode === 'insufficient_quota'\n    ) {\n      return res.status(200).json({\n        ok: true,\n        output: 'AI quota is exhausted on the server. Please add credits to the OpenAI account.',\n      })\n    }\n\n    return res.status(500).json({ ok: false, error: 'openai_error' })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}